<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="从混沌到秩序：状态模式的哲学与艺术 文 / 你的AI导师\n引子：图灵机与万物皆流 1936年，年仅24岁的艾伦·图灵（Alan Turing）向伦敦数学学会提交了一篇划时代的论文——《论可计算数及其在判定问题上的应用》。在这篇论文中，他构想了一种简单的机器：它有一条无限长的纸带，一个读写头，以及一套控制规则。\n">
<title></title>

<link rel='canonical' href='https://lcx823.github.io/lcx823/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A1%8C%E4%B8%BA%E5%9E%8B-%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/'>

<link rel="stylesheet" href="/lcx823/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css"><meta property='og:title' content="">
<meta property='og:description' content="从混沌到秩序：状态模式的哲学与艺术 文 / 你的AI导师\n引子：图灵机与万物皆流 1936年，年仅24岁的艾伦·图灵（Alan Turing）向伦敦数学学会提交了一篇划时代的论文——《论可计算数及其在判定问题上的应用》。在这篇论文中，他构想了一种简单的机器：它有一条无限长的纸带，一个读写头，以及一套控制规则。\n">
<meta property='og:url' content='https://lcx823.github.io/lcx823/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A1%8C%E4%B8%BA%E5%9E%8B-%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/'>
<meta property='og:site_name' content='yyy'>
<meta property='og:type' content='article'><meta property='article:section' content='设计模式' />
<meta name="twitter:title" content="">
<meta name="twitter:description" content="从混沌到秩序：状态模式的哲学与艺术 文 / 你的AI导师\n引子：图灵机与万物皆流 1936年，年仅24岁的艾伦·图灵（Alan Turing）向伦敦数学学会提交了一篇划时代的论文——《论可计算数及其在判定问题上的应用》。在这篇论文中，他构想了一种简单的机器：它有一条无限长的纸带，一个读写头，以及一套控制规则。\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/lcx823/">
                
                    
                    
                    
                        
                        <img src="/lcx823/img/avatar_hu_bdf33bd95d7d61a2.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">😉</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/lcx823">yyy</a></h1>
            <h2 class="site-description">演示说明</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/3494362409339008'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" id="Bilibili--Streamline-Font-Awesome" height="16" width="16"><desc>Bilibili Streamline Icon: https://streamlinehq.com</desc><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M15.123284375 4.0830875c0.511434375 0.55430625 0.747246875 1.215803125 0.713559375 2.01205v6.1984625c-0.01225 0.80849375 -0.28175 1.473053125 -0.811559375 1.993675 -0.526746875 0.520621875 -1.197428125 0.79318125 -2.005925 0.81768125H2.978096875c-0.810028125 -0.0245 -1.476425 -0.300121875 -1.999190625 -0.83299375C0.456509375 13.739090625 0.18348125 13.03778125 0.16 12.1711V6.0951375c0.02348125 -0.796246875 0.296509375 -1.45774375 0.81890625 -2.01205 0.522765625 -0.50071875 1.1891625 -0.775728125 1.999190625 -0.799309375h0.89975625L3.1015125 2.493353125c-0.176090625 -0.17548125 -0.264290625 -0.398125 -0.264290625 -0.667315625 0 -0.2695 0.0882 -0.491834375 0.264290625 -0.667528125 0.17609375 -0.175634375 0.39965625 -0.263465625 0.669153125 -0.263465625s0.493059375 0.08783125 0.670684375 0.263465625l2.2448 2.12526875h2.69498125l2.28155 -2.12526875c0.1868125 -0.175634375 0.416496875 -0.263465625 0.685996875 -0.263465625 0.269496875 0 0.493059375 0.08783125 0.67068125 0.263465625 0.1745625 0.17569375 0.263375 0.398028125 0.263375 0.667528125 0 0.269190625 -0.0888125 0.491834375 -0.263375 0.667315625l-0.77480625 0.790425h0.89730625c0.808496875 0.02358125 1.469990625 0.298590625 1.981425 0.799309375Zm-1.188240625 2.134546875c-0.01225 -0.293996875 -0.1133125 -0.532871875 -0.3276875 -0.71968125 -0.15925 -0.1868125 -0.428746875 -0.287875 -0.695184375 -0.300125H3.1015125c-0.293690625 0.01225 -0.534403125 0.1133125 -0.72213125 0.300125 -0.1880375 0.186809375 -0.287875 0.425684375 -0.2995125 0.71968125v5.953465625c0 0.28175 0.0998375 0.520621875 0.2995125 0.719684375s0.440384375 0.300121875 0.72213125 0.300121875h9.8106625c0.281746875 0 0.520621875 -0.1010625 0.71355625 -0.300121875 0.1929375 -0.1990625 0.2970625 -0.4379375 0.3093125 -0.719684375V6.217634375Zm-8.094140625 1.30768125c0.1929375 0.1929375 0.2970625 0.431809375 0.3093125 0.710496875v1.01980625c-0.01225 0.281746875 -0.1133125 0.517559375 -0.300125 0.71049375 -0.189871875 0.1929375 -0.428746875 0.2909375 -0.72274375 0.2909375 -0.294 0 -0.535934375 -0.098 -0.722746875 -0.2909375 -0.1868125 -0.192934375 -0.287871875 -0.428746875 -0.300121875 -0.71049375V8.2358125c0.01225 -0.2786875 0.116371875 -0.517559375 0.309309375 -0.710496875 0.1929375 -0.1929375 0.404246875 -0.293996875 0.713559375 -0.306246875 0.281746875 0.01225 0.520621875 0.113309375 0.71355625 0.306246875Zm5.864653125 0c0.192934375 0.1929375 0.297059375 0.431809375 0.309309375 0.710496875v1.01980625c-0.01225 0.281746875 -0.1133125 0.517559375 -0.300121875 0.71049375 -0.1868125 0.1929375 -0.428746875 0.2909375 -0.722746875 0.2909375 -0.293996875 0 -0.532871875 -0.098 -0.72274375 -0.2909375 -0.214375 -0.192934375 -0.287875 -0.428746875 -0.2970625 -0.71049375V8.2358125c0.0091875 -0.2786875 0.1133125 -0.517559375 0.30625 -0.710496875 0.192934375 -0.1929375 0.431809375 -0.293996875 0.71355625 -0.306246875 0.28175 0.01225 0.520621875 0.113309375 0.713559375 0.306246875Z" fill="#000000" stroke-width="0.0313"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/lcx823/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/lcx823/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/lcx823/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/lcx823/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/lcx823/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>友链</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#引子图灵机与万物皆流">引子：图灵机与万物皆流</a></li>
    <li><a href="#第一章复杂性的诅咒为什么要消灭-if-else">第一章：复杂性的诅咒——为什么要消灭 if-else</a></li>
    <li><a href="#第二章分而治之的智慧状态模式的核心机制">第二章：分而治之的智慧——状态模式的核心机制</a>
      <ol>
        <li><a href="#1-抽象状态state-interface">1. 抽象状态（State Interface）</a></li>
        <li><a href="#2-具体状态concrete-states">2. 具体状态（Concrete States）</a></li>
        <li><a href="#3-上下文环境context">3. 上下文环境（Context）</a></li>
      </ol>
    </li>
    <li><a href="#第三章难点突破谁来控制状态机的齿轮">第三章：难点突破——谁来控制状态机的齿轮？</a>
      <ol>
        <li><a href="#方案一去中心化状态内部控制">方案一：去中心化（状态内部控制）</a></li>
        <li><a href="#方案二中心化context控制">方案二：中心化（Context控制）</a></li>
        <li><a href="#方案三表驱动法table-driven">方案三：表驱动法（Table-Driven）</a></li>
      </ol>
    </li>
    <li><a href="#第四章应用与扩展从代码到有限状态机">第四章：应用与扩展——从代码到有限状态机</a>
      <ol>
        <li><a href="#1-游戏开发中的灵魂">1. 游戏开发中的灵魂</a></li>
        <li><a href="#2-工业控制与嵌入式">2. 工业控制与嵌入式</a></li>
        <li><a href="#3-工作流引擎workflow-engine">3. 工作流引擎（Workflow Engine）</a></li>
      </ol>
    </li>
    <li><a href="#结语在变化的洪流中构建秩序">结语：在变化的洪流中构建秩序</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/lcx823/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A1%8C%E4%B8%BA%E5%9E%8B-%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/"></a>
        </h2>
    
        
    </div>

    
    
    
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="从混沌到秩序状态模式的哲学与艺术">从混沌到秩序：状态模式的哲学与艺术
</h1><p><strong>文 / 你的AI导师</strong></p>
<h2 id="引子图灵机与万物皆流">引子：图灵机与万物皆流
</h2><p>1936年，年仅24岁的艾伦·图灵（Alan Turing）向伦敦数学学会提交了一篇划时代的论文——《论可计算数及其在判定问题上的应用》。在这篇论文中，他构想了一种简单的机器：它有一条无限长的纸带，一个读写头，以及一套控制规则。</p>
<p>这个机器最核心的奥秘，并不在于那条无限长的纸带（那是存储），也不在于读写头（那是I/O），而在于那个看似不起眼的“内部配置”（Internal Configuration）。图灵后来将其称为**“状态”（State）**。</p>
<p>机器在任何时刻都处于某一特定的状态中。当它读取到纸带上的一个符号时，它会根据“当前状态”和“输入符号”，决定做一个动作（比如改写符号、移动纸带），然后跳转到“下一个状态”。</p>
<p>这个朴素的模型，就是现代计算机的鼻祖——图灵机。</p>
<p>你可能会问，为什么我要在讲设计模式时，扯到80多年前的图灵机？</p>
<p>因为我想告诉你一个计算机科学的第一性原理：<strong>计算的本质，就是状态的流转。</strong></p>
<p>无论是你手机里运行的复杂App，还是控制火箭发射的精密系统，归根结底，都是一个巨大的、复杂的状态机。然而，在实际的软件工程中，处理“状态”往往是我们最头疼的地方。</p>
<p>你一定见过这样的代码：一个几千行的类，里面充斥着无数的 <code>if (status == 1) { ... } else if (status == 2) { ... }</code>。这种代码就像一团乱麻，剪不断，理还乱。一旦需求变更，增加了一个新状态，整个系统就可能崩溃。</p>
<p>这不仅是代码的丑陋，更是思维的懒惰。</p>
<p>古希腊哲学家赫拉克利特曾说：“人不能两次踏进同一条河流。”万物皆流，无物常驻。在软件世界里，对象也是如此。一个“订单”对象，昨天是“待支付”，今天是“已发货”，明天是“已签收”。对象还是那个对象，但它的行为（Behavior）却因为状态的改变而发生了翻天覆地的变化。</p>
<p>如何优雅地管理这种变化？如何让代码像数学公式一样简洁、像图灵机一样逻辑严密，却又具有极高的扩展性？</p>
<p>这就是我们要探讨的主题：<strong>状态模式（State Pattern）</strong>。</p>
<p>当你理解了状态模式，你不仅掌握了一种代码技巧，更理解了如何通过“分治”的思想，将混沌的时间流，切割成秩序井然的切片。</p>
<hr>
<h2 id="第一章复杂性的诅咒为什么要消灭-if-else">第一章：复杂性的诅咒——为什么要消灭 if-else
</h2><p>在信息论中，香农告诉我们，信息是为了消除不确定性。而在软件设计中，模式是为了消除复杂性。</p>
<p>为了理解状态模式的必要性，我们先来看一个反面教材。假设你正在为一家物流公司开发一个包裹追踪系统。一个包裹（Package）在其生命周期中，可能会经历以下几个阶段：</p>
<ol>
<li><strong>New（新建）</strong>：刚下单，等待揽收。</li>
<li><strong>InTransit（运输中）</strong>：已被揽收，正在路上。</li>
<li><strong>Delivered（已送达）</strong>：客户签收。</li>
<li><strong>Lost（丢失）</strong>：很不幸，包裹找不到了。</li>
</ol>
<p>作为一名初出茅庐的程序员，直觉会让你写出这样的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Package</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 定义状态常量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NEW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">IN_TRANSIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">DELIVERED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">2</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">LOST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NEW</span><span class="p">;</span><span class="w"> </span><span class="c1">// 当前状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 更新物流信息的方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLocation</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">location</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NEW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IN_TRANSIT</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;包裹已揽收，当前在：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IN_TRANSIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;包裹到达：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DELIVERED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;错误：包裹已签收，不能更新位置。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LOST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;错误：包裹已丢失，无法更新位置。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 签收方法</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sign</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NEW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;错误：包裹还没发货呢，怎么签收？&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">IN_TRANSIT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DELIVERED</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;包裹签收成功。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DELIVERED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;包裹已经签收过了。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">LOST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;错误：包裹丢了，无法签收。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ... 还有更多方法，每个方法里都有类似的 if-else</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这段代码能跑通吗？当然能。计算机并不在乎代码好不好看，它只执行指令。</p>
<p>但是，从工程学的角度看，这段代码是“有毒”的。</p>
<p><strong>首先，它违反了“开闭原则”（Open/Closed Principle）。</strong>
如果业务方突然说：“我们要增加一个‘退货中（Returning）’的状态。”你需要做什么？你需要打开 <code>Package</code> 类，找到每一个方法（updateLocation, sign, etc.），在每一个 <code>if-else</code> 结构中插一脚。这就像修一座大楼，每次加个房间都要把地基挖开一样危险。</p>
<p><strong>其次，它具有极高的“圈复杂度”（Cyclomatic Complexity）。</strong>
每一个 <code>if</code> 分支都是一个逻辑陷阱。当状态从4个变成10个，方法从2个变成20个时，你将面对一个由几百个分支组成的迷宫。维护这种代码，是对程序员智商和耐心的双重侮辱。</p>
<p><strong>最后，它不符合“面向对象”的本质。</strong>
面向对象的核心是将数据和行为封装在一起。在这里，<code>state</code> 只是一个冷冰冰的数字，它没有行为。真正的业务逻辑散落在各个方法的角落里。</p>
<p>我们需要一种方法，将“状态”从一个简单的字段，升级为一个拥有尊严的“对象”。</p>
<hr>
<h2 id="第二章分而治之的智慧状态模式的核心机制">第二章：分而治之的智慧——状态模式的核心机制
</h2><p>吴军老师在《数学之美》中常提到，许多复杂的工程问题，最终都可以归结为数学上的“正交化”或“降维”。</p>
<p>状态模式的核心思想，就是将**“状态的判断逻辑”<strong>与</strong>“核心业务逻辑”**剥离，并将每一个状态的行为封装到独立的类中。</p>
<p>让我们用“拟人化”的方式来思考。</p>
<p>在之前的代码中，<code>Package</code> 类像是一个精神分裂的演员，他一会儿要扮演刚出生的婴儿（New），一会儿要扮演奔跑的青年（InTransit），一会儿要扮演安详的老人（Delivered）。他在每一句台词前都要问自己：“我现在是谁？”</p>
<p>状态模式则是雇佣了一个替身团队。<code>Package</code> 类变成了一个导演（Context），他不再亲自表演，而是持有一个“当前演员”（Current State Object）。</p>
<ul>
<li>当状态是 <code>New</code> 时，持有 <code>NewState</code> 对象，由它来处理动作。</li>
<li>当状态切换到 <code>InTransit</code> 时，导演把 <code>NewState</code> 踢开，换上 <code>InTransitState</code> 对象。</li>
</ul>
<p>这样，<code>Package</code> 类就不需要写 <code>if-else</code> 了，它只需要喊一句：“Action！”（调用当前状态对象的方法），具体的表演由当前对象完成。</p>
<p>让我们看看这种结构是如何在代码中体现的。</p>
<h3 id="1-抽象状态state-interface">1. 抽象状态（State Interface）
</h3><p>首先，我们需要定义一个接口，规定所有状态必须具备的行为。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">PackageState</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLocation</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="2-具体状态concrete-states">2. 具体状态（Concrete States）
</h3><p>接下来，我们为每一个状态创建一个类。注意，这里的逻辑变得非常纯粹。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// 新建状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NewState</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">PackageState</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLocation</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">location</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;包裹已揽收，出发前往：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 关键点：状态的流转在这里发生</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">setState</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">InTransitState</span><span class="p">());</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;错误：包裹未发货，无法签收。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 运输中状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">InTransitState</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">PackageState</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLocation</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">location</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;包裹到达中转站：&#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 状态不变</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;签收成功！&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ctx</span><span class="p">.</span><span class="na">setState</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">DeliveredState</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c1">// 已送达状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DeliveredState</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">PackageState</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLocation</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">location</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;已签收包裹，不再更新位置。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span><span class="n">PackageContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;您已经签收过了。&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="3-上下文环境context">3. 上下文环境（Context）
</h3><p>最后是我们的 <code>Package</code> 类，现在它变得异常干净。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PackageContext</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">PackageState</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PackageContext</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// 初始状态</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NewState</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 设置新状态的方法，通常由 State 对象调用</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setState</span><span class="p">(</span><span class="n">PackageState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 业务方法：直接委托给当前状态对象</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">updateLocation</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">location</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="na">updateLocation</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">location</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sign</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="na">sign</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>看到变化了吗？</p>
<p>原来那个巨大的 <code>updateLocation</code> 方法里的 <code>if-else</code> 迷宫消失了。取而代之的是多态（Polymorphism）的魔法。</p>
<p>这不仅仅是代码行数的改变，这是<strong>控制权的反转</strong>。以前是 <code>Package</code> 类控制一切，现在通过委托，<code>Package</code> 类把具体的行为逻辑下放给了各个 <code>State</code> 类。</p>
<p>这就是**单一职责原则（Single Responsibility Principle）**的胜利。<code>NewState</code> 只关心新建状态下该干什么，它不需要知道 <code>DeliveredState</code> 的逻辑。如果要加一个 <code>ReturningState</code>，你只需要新建一个类，然后修改一下触发它的那个状态即可，不需要触碰其他无关的代码。</p>
<hr>
<h2 id="第三章难点突破谁来控制状态机的齿轮">第三章：难点突破——谁来控制状态机的齿轮？
</h2><p>理解了基本结构后，我们必须深入探讨一个工程实践中的棘手问题：<strong>状态转换（State Transition）的逻辑究竟该放在哪里？</strong></p>
<p>在上面的代码中，你可能注意到了，我在 <code>NewState.updateLocation</code> 中写了 <code>ctx.setState(new InTransitState())</code>。这意味着，<strong>当前状态知道它的下一个状态是谁</strong>。</p>
<p>这是一种常见的做法，但它并非没有代价。</p>
<h3 id="方案一去中心化状态内部控制">方案一：去中心化（状态内部控制）
</h3><p>这就是我们刚才演示的。</p>
<ul>
<li><strong>优点</strong>：符合直觉。状态A自然知道在什么条件下变成状态B。</li>
<li><strong>缺点</strong>：状态类之间产生了耦合。<code>NewState</code> 必须依赖 <code>InTransitState</code>。如果你想修改流程，比如在 <code>New</code> 和 <code>InTransit</code> 之间加一个 <code>SecurityCheck</code>（安检）状态，你需要修改 <code>NewState</code> 的源代码。</li>
</ul>
<h3 id="方案二中心化context控制">方案二：中心化（Context控制）
</h3><p>我们可以让 <code>Context</code> 来决定流转。<code>State</code> 方法可以返回一个布尔值或枚举，告诉 <code>Context</code> 发生了什么，然后由 <code>Context</code> 决定切到哪个状态。</p>
<ul>
<li><strong>优点</strong>：状态类之间解耦，它们变得完全独立。</li>
<li><strong>缺点</strong>：<code>Context</code> 再次变得臃肿，如果不小心，那个讨厌的 <code>if-else</code> 逻辑可能会在 <code>Context</code> 中死灰复燃。</li>
</ul>
<h3 id="方案三表驱动法table-driven">方案三：表驱动法（Table-Driven）
</h3><p>对于非常复杂的状态机（比如游戏角色的状态：跑、跳、蹲、攻击、受击，且可以组合），我们可以引入一张“状态转换表”。</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">当前状态</th>
          <th style="text-align: left">触发事件</th>
          <th style="text-align: left">下一个状态</th>
          <th style="text-align: left">动作</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">New</td>
          <td style="text-align: left">updateLocation</td>
          <td style="text-align: left">InTransit</td>
          <td style="text-align: left">Print Log</td>
      </tr>
      <tr>
          <td style="text-align: left">InTransit</td>
          <td style="text-align: left">sign</td>
          <td style="text-align: left">Delivered</td>
          <td style="text-align: left">Send Email</td>
      </tr>
      <tr>
          <td style="text-align: left">&hellip;</td>
          <td style="text-align: left">&hellip;</td>
          <td style="text-align: left">&hellip;</td>
          <td style="text-align: left">&hellip;</td>
      </tr>
  </tbody>
</table></div>
<p>这种方法在编译器设计（词法分析）和嵌入式系统中非常常见。它将逻辑完全数据化，甚至可以把这张表存在数据库或配置文件里。</p>
<p><strong>吴军视角的思考：</strong></p>
<p>在计算机科学中，没有绝对完美的方案，只有最适合场景的权衡（Trade-off）。</p>
<ul>
<li>如果你的业务流程是线性的（如审批流），<strong>方案一</strong>（去中心化）通常是最简洁的。</li>
<li>如果你的状态流转非常复杂，且经常变化（如电商大促期间的订单规则），<strong>方案三</strong>（表驱动）虽然实现成本高，但维护成本最低，体现了“数据与代码分离”的高级智慧。</li>
</ul>
<p>此外，还有一个细节值得注意：<strong>状态对象的生命周期</strong>。
在上面的代码中，每次切换状态我都 <code>new</code> 了一个新对象。如果状态对象没有成员变量（是无状态的），这是一种浪费。
这时，我们可以结合<strong>单例模式（Singleton）<strong>或</strong>享元模式（Flyweight）</strong>，让系统中所有的 <code>Package</code> 对象共享同一个 <code>NewState</code> 实例。这在处理百万级并发订单时，对内存的节省是惊人的。</p>
<hr>
<h2 id="第四章应用与扩展从代码到有限状态机">第四章：应用与扩展——从代码到有限状态机
</h2><p>当你掌握了状态模式，你就拿到了一把打开更广阔世界的钥匙：<strong>有限状态机（Finite State Machine, FSM）</strong>。</p>
<p>状态模式其实是 FSM 的面向对象实现版本。FSM 是计算机科学的基石之一。</p>
<h3 id="1-游戏开发中的灵魂">1. 游戏开发中的灵魂
</h3><p>在游戏开发中，FSM 无处不在。
想象《超级马里奥》里的怪物。它在巡逻（Patrol State），看到你后变成追击（Chase State），被你踩了变成死亡（Dead State）。
如果不用状态模式，怪物的 AI 代码将是一场灾难。现代游戏引擎（如 Unity 或 Unreal）甚至提供了可视化的状态机编辑器，让设计师不用写代码就能通过连线来定义行为。这说明，状态模式的思想已经超越了代码，成为了设计工具的一部分。</p>
<h3 id="2-工业控制与嵌入式">2. 工业控制与嵌入式
</h3><p>你家的微波炉、洗衣机，路口的红绿灯，都是硬件级别的状态机。在这些领域，程序的正确性至关重要。状态模式（特别是结合表驱动法）能够确保系统在任何时刻都在预定义的轨道上运行，绝不会出现“洗衣机在脱水时突然开始注水”这种逻辑错误。</p>
<h3 id="3-工作流引擎workflow-engine">3. 工作流引擎（Workflow Engine）
</h3><p>在企业级应用中，请假审批、合同签署、Bug 追踪，这些都是状态流转。
简单的场景我们手写状态模式，而复杂的场景，我们会引入像 <strong>Spring State Machine</strong> 或 <strong>Activiti</strong> 这样的框架。这些框架本质上就是把状态模式通用化、配置化了。</p>
<p><strong>辨析：状态模式 vs 策略模式</strong></p>
<p>这是一个经典的面试题，也是理解设计模式的试金石。
从类图上看，状态模式和策略模式（Strategy Pattern）几乎一模一样：都是 Context 持有一个接口，接口有多个实现类。</p>
<p>但它们的**意图（Intent）**截然不同。</p>
<ul>
<li><strong>策略模式</strong>是关于**“怎么做”**（How）。比如排序，是用冒泡还是快排？用户通常主动选择一种策略，并且在执行过程中很少改变。它是横向的替代。</li>
<li><strong>状态模式</strong>是关于**“是什么”**（What/When）。对象现在的状态是什么？状态的切换通常是自动发生的（由内部逻辑触发），用户往往不需要关心具体是哪个状态类在工作。它是纵向的演变。</li>
</ul>
<p>用一个生活类比：</p>
<ul>
<li><strong>策略模式</strong>：你想去北京，你可以选择“坐飞机策略”或“坐高铁策略”。这是你的选择。</li>
<li><strong>状态模式</strong>：人的一生，从“婴儿”到“青年”到“老年”。这不是你选的，而是时间流逝自然发生的，且你在不同阶段的行为能力完全不同。</li>
</ul>
<hr>
<h2 id="结语在变化的洪流中构建秩序">结语：在变化的洪流中构建秩序
</h2><p>在文章的最后，让我们跳出代码的细节，回到思维的高度。</p>
<p>吴军老师在《数学之美》中反复强调：<strong>好的方法论往往是通用的。</strong></p>
<p>状态模式不仅仅是一种编程技巧，它更是一种<strong>认识世界和管理复杂性的哲学</strong>。</p>
<p>我们在生活中也面临着同样的困境。当我们试图同时处理所有可能性时，我们会焦虑、混乱（就像那个充满 <code>if-else</code> 的类）。
而状态模式告诉我们要<strong>专注当下</strong>。</p>
<ul>
<li>处于“工作状态”时，就屏蔽娱乐的干扰，专注输出；</li>
<li>处于“休息状态”时，就切断工作的联系，专注恢复。</li>
</ul>
<p>通过明确定义每一个“状态”的边界和行为，通过规范化“状态”之间的转换规则，我们不仅能写出健壮的代码，也能构建出高效的人生。</p>
<p><strong>给学习者的建议：</strong></p>
<ol>
<li><strong>不要过度设计</strong>。如果你的对象只有两个状态（开/关），一个 <code>boolean</code> 变量足矣。只有当状态超过3个，且状态之间的转化逻辑变得复杂时，才考虑重构为状态模式。</li>
<li><strong>画图胜过千言万语</strong>。在写代码前，先画一张<strong>状态迁移图（State Transition Diagram）</strong>。如果你画不清楚图，说明你还没想清楚逻辑，这时候写代码只会制造Bug。</li>
<li><strong>关注副作用</strong>。状态切换时，往往伴随着副作用（如数据库更新、发送通知）。确保这些副作用被封装在正确的地方（是进入状态时触发？还是离开状态时触发？）。</li>
</ol>
<p>计算机科学的历史，就是人类试图用有限的逻辑，去捕捉无限变化的世界的历史。图灵机做到了，有限状态机做到了，而当你熟练运用状态模式时，你也做到了。</p>
<p>愿你在代码的世界里，不仅能看到字符的跳动，更能看到逻辑的韵律与数学之美。</p>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 yyy&#39;s blog
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/lcx823/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
